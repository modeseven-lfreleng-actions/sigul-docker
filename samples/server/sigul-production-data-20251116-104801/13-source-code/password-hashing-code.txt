=== Password Hashing Logic ===
/usr/share/sigul/client.py-    def send_inner(self, inner_fields, omit_payload_auth=False):
/usr/share/sigul/client.py-        '''Send the inner header, including inner_fields.'''
/usr/share/sigul/client.py-        # FIXME: handle errors.UNKNOWN_VERSION - there is no inner session and
/usr/share/sigul/client.py-        # outer session data is not all read
/usr/share/sigul/client.py-        fields = dict(inner_fields) # Shallow copy
/usr/share/sigul/client.py:        fields['header-auth-sha512'] = self.__request_header_writer.sha512()
/usr/share/sigul/client.py-        if not omit_payload_auth:
/usr/share/sigul/client.py:            fields['payload-auth-sha512'] = \
/usr/share/sigul/client.py:                self.__request_payload_writer.sha512()
/usr/share/sigul/client.py-
/usr/share/sigul/client.py-        mech = nss.nss.CKM_SHA512_HMAC
/usr/share/sigul/client.py-        slot = nss.nss.get_best_slot(mech)
/usr/share/sigul/client.py-        nss_key = slot.key_gen(mech, None, 64)
/usr/share/sigul/client.py-        fields['header-auth-key'] = nss_key.key_data
/usr/share/sigul/client.py-        self.__reply_header_reader = \
/usr/share/sigul/client.py-            utils.SHA512HMACReader(self.__client.outer_read, nss_key)
/usr/share/sigul/client.py-        nss_key = slot.key_gen(mech, None, 64)
/usr/share/sigul/client.py-        fields['payload-auth-key'] = nss_key.key_data
/usr/share/sigul/client.py-        self.__reply_payload_reader = \
/usr/share/sigul/client.py-            utils.SHA512HMACReader(self.__client.outer_read, nss_key)
/usr/share/sigul/client.py-
/usr/share/sigul/client.py-        try:
/usr/share/sigul/client.py-            self.__client.inner_open_client(self.config.server_hostname,
/usr/share/sigul/client.py-                                            self.config.client_cert_nickname)
/usr/share/sigul/client.py-        except double_tls.InnerCertificateNotFound, e:
/usr/share/sigul/client.py-            raise ClientError(str(e))
/usr/share/sigul/client.py-        try:
/usr/share/sigul/client.py-            self.__client.inner_write(utils.format_fields(fields))
/usr/share/sigul/client.py-        finally:
--
/usr/share/sigul/server_common.py-        random = nss.nss.generate_random(self.__salt_length)
/usr/share/sigul/server_common.py-        salt = '$6$'
/usr/share/sigul/server_common.py-        for i in xrange(self.__salt_length):
/usr/share/sigul/server_common.py-            salt += self.__salt_characters[ord(random[i]) %
/usr/share/sigul/server_common.py-                                           len(self.__salt_characters)]
/usr/share/sigul/server_common.py:        self.sha512_password = crypt.crypt(clear_password, salt)
/usr/share/sigul/server_common.py-    clear_password = property(fset = __set_clear_password,
/usr/share/sigul/server_common.py-                              doc='Setting this attribute updates '
/usr/share/sigul/server_common.py:                              'sha512_password')
/usr/share/sigul/server_common.py-
/usr/share/sigul/server_common.py-class Key(object):
/usr/share/sigul/server_common.py-    def __init__(self, name, fingerprint):
/usr/share/sigul/server_common.py-        self.name = name
/usr/share/sigul/server_common.py-        self.fingerprint = fingerprint
/usr/share/sigul/server_common.py-
/usr/share/sigul/server_common.py-class KeyAccess(object):
/usr/share/sigul/server_common.py-    def __init__(self, key, user, key_admin=False):
/usr/share/sigul/server_common.py-        self.key = key
/usr/share/sigul/server_common.py-        self.user = user
/usr/share/sigul/server_common.py-        self.key_admin = key_admin
/usr/share/sigul/server_common.py-        self.encrypted_passphrase = None
/usr/share/sigul/server_common.py-
/usr/share/sigul/server_common.py-    def get_passphrase(self, config, user_passphrase):
/usr/share/sigul/server_common.py-        if self.encrypted_passphrase is None:
/usr/share/sigul/server_common.py-            # Perform a decryption attempt anyway to make timing attacks more
/usr/share/sigul/server_common.py-            # difficult.  gpg will probably choke on the attempt quickly
/usr/share/sigul/server_common.py-            # enough, too bad.
/usr/share/sigul/server_common.py-            encrypted_passphrase = 'x'
/usr/share/sigul/server_common.py-        else:
--
/usr/share/sigul/server_common.py-                           sa.Column('id', sa.Integer,
/usr/share/sigul/server_common.py-                                     sa.Sequence('users_id_seq', optional=True),
/usr/share/sigul/server_common.py-                                     primary_key=True),
/usr/share/sigul/server_common.py-                           sa.Column('name', sa.Text, nullable=False,
/usr/share/sigul/server_common.py-                                     unique=True),
/usr/share/sigul/server_common.py:                           sa.Column('sha512_password', sa.Binary),
/usr/share/sigul/server_common.py-                           sa.Column('admin', sa.Boolean, nullable=False))
/usr/share/sigul/server_common.py-
/usr/share/sigul/server_common.py-_db_keys_table = sa.Table('keys', _db_metadata,
/usr/share/sigul/server_common.py-                          sa.Column('id', sa.Integer,
/usr/share/sigul/server_common.py-                                    sa.Sequence('keys_id_seq', optional=True),
/usr/share/sigul/server_common.py-                                    primary_key=True),
/usr/share/sigul/server_common.py-                          sa.Column('name', sa.Text, nullable=False,
/usr/share/sigul/server_common.py-                                    unique=True),
/usr/share/sigul/server_common.py-                          sa.Column('fingerprint', sa.Text, nullable=False,
/usr/share/sigul/server_common.py-                                    unique=True))
/usr/share/sigul/server_common.py-
/usr/share/sigul/server_common.py-_db_key_accesses_table = sa.Table('key_accesses', _db_metadata,
/usr/share/sigul/server_common.py-                                  sa.Column('id', sa.Integer,
/usr/share/sigul/server_common.py-                                            sa.Sequence('key_accesses_id_seq',
/usr/share/sigul/server_common.py-                                                        optional=True),
/usr/share/sigul/server_common.py-                                            primary_key=True),
/usr/share/sigul/server_common.py-                                  sa.Column('key_id', sa.Integer,
/usr/share/sigul/server_common.py-                                            sa.ForeignKey('keys.id'),
/usr/share/sigul/server_common.py-                                            nullable=False),
/usr/share/sigul/server_common.py-                                  sa.Column('user_id', sa.Integer,
--
/usr/share/sigul/server.py-            try:
/usr/share/sigul/server.py-                utils.copy_data(f.write, reader.read, payload_size)
/usr/share/sigul/server.py-            finally:
/usr/share/sigul/server.py-                f.close()
/usr/share/sigul/server.py-            self.payload_file = open(self.payload_path, 'rb')
/usr/share/sigul/server.py:        self.payload_sha512_digest = reader.sha512()
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-        # FIXME? authenticate using the client's certificate as well?
/usr/share/sigul/server.py-        # May raise double_tls.InnerCertificateNotFound.
/usr/share/sigul/server.py-        self.__client.inner_open_server(self.config.server_cert_nickname)
/usr/share/sigul/server.py-        try:
/usr/share/sigul/server.py-            try:
/usr/share/sigul/server.py-                self.__inner_fields = utils.read_fields(self.__client.
/usr/share/sigul/server.py-                                                        inner_read)
/usr/share/sigul/server.py-            except utils.InvalidFieldsError, e:
/usr/share/sigul/server.py-                raise InvalidRequestError(str(e))
/usr/share/sigul/server.py-        finally:
/usr/share/sigul/server.py-            self.__client.inner_close()
/usr/share/sigul/server.py-        # print repr(self.__inner_fields)
/usr/share/sigul/server.py:        if (self.inner_field('header-auth-sha512', required=True) !=
/usr/share/sigul/server.py:            nss.nss.sha512_digest(header_data)):
/usr/share/sigul/server.py-            raise InvalidRequestError('Header authentication failed')
/usr/share/sigul/server.py:        payload_auth = self.inner_field('payload-auth-sha512')
/usr/share/sigul/server.py-        if payload_auth is None:
/usr/share/sigul/server.py-            if not handler.payload_auth_optional:
/usr/share/sigul/server.py-                raise InvalidRequestError('Authentication hash missing')
/usr/share/sigul/server.py-        else:
/usr/share/sigul/server.py:            if payload_auth != self.payload_sha512_digest:
/usr/share/sigul/server.py-                raise InvalidRequestError('Payload authentication failed')
/usr/share/sigul/server.py-        self.payload_authenticated = payload_auth is not None
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-        mech = nss.nss.CKM_SHA512_HMAC
/usr/share/sigul/server.py-        slot = nss.nss.get_best_slot(mech)
/usr/share/sigul/server.py-        buf = self.inner_field('header-auth-key', required=True)
/usr/share/sigul/server.py-        if len(buf) < 64:
/usr/share/sigul/server.py-            raise InvalidRequestError('Header authentication key too small')
/usr/share/sigul/server.py-        # "Unwrap" because the key was encrypted for transmission using TLS
/usr/share/sigul/server.py-        nss_key = nss.nss.import_sym_key(slot, mech, nss.nss.PK11_OriginUnwrap,
/usr/share/sigul/server.py-                                         nss.nss.CKA_SIGN, nss.nss.SecItem(buf))
/usr/share/sigul/server.py-        self.__reply_header_writer = \
/usr/share/sigul/server.py-            utils.SHA512HMACWriter(self.__client.outer_write, nss_key)
/usr/share/sigul/server.py-        buf = self.inner_field('payload-auth-key', required=True)
/usr/share/sigul/server.py-        if len(buf) < 64:
/usr/share/sigul/server.py-            raise InvalidRequestError('Payload authentication key too small')
/usr/share/sigul/server.py-        nss_key = nss.nss.import_sym_key(slot, mech, nss.nss.PK11_OriginUnwrap,
/usr/share/sigul/server.py-                                         nss.nss.CKA_SIGN, nss.nss.SecItem(buf))
/usr/share/sigul/server.py-        self.__reply_payload_writer = \
/usr/share/sigul/server.py-            utils.SHA512HMACWriter(self.__client.outer_write, nss_key)
--
/usr/share/sigul/server.py-        try:
/usr/share/sigul/server.py-            utils.copy_data(f.write, reader.read, payload_size)
/usr/share/sigul/server.py-        finally:
/usr/share/sigul/server.py-            f.close()
/usr/share/sigul/server.py-        payload_file = open(payload_path, 'rb')
/usr/share/sigul/server.py:        payload_sha512_digest = reader.sha512()
/usr/share/sigul/server.py-        auth = self.__client.outer_read(64)
/usr/share/sigul/server.py:        return (payload_path, payload_file, payload_sha512_digest,
/usr/share/sigul/server.py-                auth == reader.hmac())
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-    def send_subheader(self, fields, nss_key):
/usr/share/sigul/server.py-        '''Send fields in a subreply header authenticated using nss_key.'''
/usr/share/sigul/server.py-        writer = utils.SHA512HMACWriter(self.__client.outer_write, nss_key)
/usr/share/sigul/server.py-        writer.write(utils.format_fields(fields))
/usr/share/sigul/server.py-        writer.write_64B_hmac()
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-    def send_empty_subpayload(self, nss_key):
/usr/share/sigul/server.py-        '''Send an empty subreply payload authenticated using nss_key.'''
/usr/share/sigul/server.py-        self.__send_payload_size(0)
/usr/share/sigul/server.py-        writer = utils.SHA512HMACWriter(self.__client.outer_write, nss_key)
/usr/share/sigul/server.py-        writer.write_64B_hmac()
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-    def send_subpayload_from_file(self, fd, nss_key):
/usr/share/sigul/server.py-        '''Send a subreply payload from fd authenticated using nss_key.'''
/usr/share/sigul/server.py-        writer = utils.SHA512HMACWriter(self.__client.outer_write, nss_key)
/usr/share/sigul/server.py-        self.__send_payload_from_file(writer, fd)
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-    def close(self):
--
/usr/share/sigul/server.py-        self._verify_username(user)
/usr/share/sigul/server.py-        password = self.inner_field('password')
/usr/share/sigul/server.py-        if password is None:
/usr/share/sigul/server.py-            self.auth_fail('password field missing')
/usr/share/sigul/server.py-        user = db.query(User).filter_by(name=user).first()
/usr/share/sigul/server.py:        if user is not None and user.sha512_password is not None:
/usr/share/sigul/server.py:            crypted_pw = str(user.sha512_password)
/usr/share/sigul/server.py-        else:
/usr/share/sigul/server.py-            # Perform the encryption anyway to make timing attacks more
/usr/share/sigul/server.py-            # difficult.
/usr/share/sigul/server.py-            crypted_pw = 'x'
/usr/share/sigul/server.py-        if crypt.crypt(password, crypted_pw) != crypted_pw:
/usr/share/sigul/server.py-            self.auth_fail('password does not match')
/usr/share/sigul/server.py-        if not user.admin:
/usr/share/sigul/server.py-            self.auth_fail('user is not a server administrator')
/usr/share/sigul/server.py-        # OK
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-    def __authenticate_admin_or_user(self, db):
/usr/share/sigul/server.py-        '''Check the request is a valid key access request.
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-        Allow server administrators to authenticate without having a key
/usr/share/sigul/server.py-        passphrase.  Return (user, key, access), with access None if a server
/usr/share/sigul/server.py-        administrator was authenticated.  Raise RequestHandled (on permission
/usr/share/sigul/server.py-        denied), InvalidRequestError.
/usr/share/sigul/server.py-
/usr/share/sigul/server.py-        '''
/usr/share/sigul/server.py-        user = self.safe_outer_field('user')
--
/usr/share/sigul/server.py-            self.auth_fail('both password and passphrase fields missing')
/usr/share/sigul/server.py-        user = db.query(User).filter_by(name=user).first()
/usr/share/sigul/server.py-        key = db.query(Key).filter_by(name=key).first()
/usr/share/sigul/server.py-        access = None
/usr/share/sigul/server.py-        if password is not None:
/usr/share/sigul/server.py:            if user is not None and user.sha512_password is not None:
/usr/share/sigul/server.py:                crypted_pw = str(user.sha512_password)
Not found
